"use strict";(globalThis.webpackChunk_github_ui_github_ui=globalThis.webpackChunk_github_ui_github_ui||[]).push([["packages_use-alive_use-alive_ts"],{11418:(e,t,r)=>{let s;r.d(t,{H:()=>q});var n=r(35750),i=r(18150),a=r(85242),o=r(88243),l=r(16213),u=r(10204),c=new WeakMap,h=new WeakSet;let AliveSession=class AliveSession extends u.ib{constructor(e,t,r,s,n){super(e,()=>(0,o._)(this,h,d).call(this),r,s,void 0,n),(0,l._)(this,h),(0,i._)(this,c,{writable:!0,value:void 0}),(0,a._)(this,c,t)}};function d(){return b((0,n._)(this,c))}async function b(e){let t=await f(e);return t&&t.url&&t.token?p(t.url,t.token):null}async function f(e){let t=await fetch(e,{headers:{Accept:"application/json"}});if(t.ok)return t.json();if(404===t.status)return null;throw Error("fetch error")}async function p(e,t){let r=await fetch(e,{method:"POST",mode:"same-origin",headers:{"Scoped-CSRF-Token":t}});if(r.ok)return r.text();throw Error("fetch error")}var w=r(70170),m=r(34095),v=r(82075),_=r(23683),g=r(69599);function k(e,{channel:t,type:r,data:s}){for(let n of e)n.dispatchEvent(new CustomEvent(`socket:${r}`,{bubbles:!1,cancelable:!1,detail:{name:t,data:s}}))}var y=new WeakMap,M=new WeakMap,A=new WeakMap,S=new WeakMap,E=new WeakMap,P=new WeakSet;let T=class AliveSessionProxy{subscribe(e){let t=(0,n._)(this,M).add(...e);t.length&&(0,n._)(this,y).port.postMessage({subscribe:t});let r=new Set(t.map(e=>e.name)),s=e.reduce((e,t)=>{let s=t.topic.name;return(0,u.JR)(s)&&!r.has(s)&&e.add(s),e},new Set);s.size&&(0,n._)(this,y).port.postMessage({requestPresence:Array.from(s)})}unsubscribeAll(...e){let t=(0,n._)(this,M).drain(...e);t.length&&(0,n._)(this,y).port.postMessage({unsubscribe:t});let r=(0,n._)(this,A).removeSubscribers(e);this.sendPresenceMetadataUpdate(r)}updatePresenceMetadata(e){let t=new Set;for(let r of e)(0,n._)(this,A).setMetadata(r),t.add(r.channelName);this.sendPresenceMetadataUpdate(t)}sendPresenceMetadataUpdate(e){if(!e.size)return;let t=[];for(let r of e)t.push({channelName:r,metadata:(0,n._)(this,A).getChannelMetadata(r)});(0,n._)(this,y).port.postMessage({updatePresenceMetadata:t})}online(){(0,n._)(this,y).port.postMessage({online:!0})}offline(){(0,n._)(this,y).port.postMessage({online:!1})}hangup(){(0,n._)(this,y).port.postMessage({hangup:!0})}constructor(e,t,r,s,c,h){(0,l._)(this,P),(0,i._)(this,y,{writable:!0,value:void 0}),(0,i._)(this,M,{writable:!0,value:new u.m0}),(0,i._)(this,A,{writable:!0,value:new u.VH}),(0,i._)(this,S,{writable:!0,value:void 0}),(0,i._)(this,E,{writable:!0,value:new Map}),(0,a._)(this,S,c),(0,a._)(this,y,new SharedWorker(`${e}?module=true`,{name:`github-socket-worker-v3-${s}`,type:"module"})),(0,n._)(this,y).port.onmessage=({data:e})=>(0,o._)(this,P,W).call(this,e),(0,n._)(this,y).port.postMessage({connect:{url:t,refreshUrl:r,options:h}})}};function W(e){let{channel:t}=e;if("presence"===e.type){let r=(0,n._)(this,E).get(t);r||(r=(0,w.s)((e,r)=>{(0,n._)(this,S).call(this,e,r),(0,n._)(this,E).delete(t)},100),(0,n._)(this,E).set(t,r)),r((0,n._)(this,M).subscribers(t),e);return}(0,n._)(this,S).call(this,(0,n._)(this,M).subscribers(t),e)}async function C(){let e=function(){let e=document.head.querySelector("link[rel=shared-web-socket-src]")?.getAttribute("href");return e&&e.startsWith("/")?e:null}();if(!e)return;let t=document.head.querySelector("link[rel=shared-web-socket]")?.href??null;if(!t)return;let r=document.head.querySelector("link[rel=shared-web-socket]")?.getAttribute("data-refresh-url")??null;if(!r)return;let s=document.head.querySelector("link[rel=shared-web-socket]")?.getAttribute("data-session-id")??null;if(!s)return;let n=(()=>{let n=(0,g.G7)("alive_legacy_retries")?{socketPolicy:{timeout:4e3,attempts:7}}:{};if(!(0,_.nr)()&&"SharedWorker"in window&&"true"!==(0,v.A)("localStorage").getItem("bypassSharedWorker"))try{return new T(e,t,r,s,k,n)}catch{}return new AliveSession(t,r,!1,k,n)})();return window.addEventListener("online",()=>n.online()),window.addEventListener("offline",()=>n.offline()),window.addEventListener("pagehide",()=>{"hangup"in n&&n.hangup()}),n}async function x(){return await m.G,C()}function q(){return s||(s=x())}},73056:(e,t,r)=>{r.d(t,{$:()=>a});var s=r(10204),n=r(33303);let i=new WeakMap;function a(e,t,r){let a;if(!e)throw Error("Not connected to alive");if(!t)throw Error("No channel name");let o=s.KK.parse(t);if(!o)throw Error("Invalid channel name");let l={subscriber:{dispatchEvent:e=>{e instanceof CustomEvent&&r(e.detail.data)}},topic:o},u=((a=i.get(e))||(a={subscribe:(0,n.rK)(t=>e.subscribe(t.flat())),unsubscribeAll:(0,n.rK)(t=>e.unsubscribeAll(...t))},i.set(e,a)),a);return u.subscribe([l]),{unsubscribe:()=>u.unsubscribeAll(l.subscriber)}}},33303:(e,t,r)=>{function s(){return Promise.resolve()}function n(){return new Promise(window.requestAnimationFrame)}async function i(e,t){let r,s=new Promise(t=>{r=self.setTimeout(t,e)});if(!t)return s;try{var n;await Promise.race([s,(n=t,new Promise((e,t)=>{let r=Error("aborted");r.name="AbortError",n.aborted?t(r):n.addEventListener("abort",()=>t(r))}))])}catch(e){throw self.clearTimeout(r),e}}function a(e){let t=[];return function(r){t.push(r),1===t.length&&queueMicrotask(()=>{let r=t.slice(0);t.length=0,e(r)})}}r.d(t,{G$:()=>n,k2:()=>s,rK:()=>a,uk:()=>i})},40235:(e,t,r)=>{r.d(t,{x:()=>b});var s,n=r(96540),i=r(70263),a=r(11418),o=r(73056),l=r(74848),u=r(10204);let c=(0,n.createContext)(null),h=null;function d(e,t){let r=u.KK.parse(e);if(!r)throw Error(`Invalid channel name. Did you forget to sign it with \`signChannel("${e}")\`?`);return h||(h=new u.m0),h.add({topic:r,subscriber:t}),{unsubscribe:()=>{h?.delete({topic:r,subscriber:t})}}}try{c.displayName||(c.displayName="AliveTestContext")}catch{}try{(s=function({children:e,initialMessages:t}){return(0,n.useEffect)(()=>{let e=[];if(t)for(let[r,s]of t){let t=window.setTimeout(()=>{var e=r,t=s;if(null===h)throw Error('Test helper `dispatchAliveTestMessage` called outside `AliveTestProvider`. Please wrap your component under test in `AliveTestProvider` from "@github-ui/use-alive/test-utils".');for(let r of Array.from(h.subscribers(e)))r(t)},0);e.push(t)}return()=>{for(let t of(h=null,e))window.clearTimeout(t)}}),(0,l.jsx)(c.Provider,{value:d,children:e})}).displayName||(s.displayName="AliveTestProvider")}catch{}function b(e,t){let r=(0,i.A)(),s=(0,n.useContext)(c);(0,n.useEffect)(()=>{let n=()=>{},i=!1;return async function(){if(e){if("function"==typeof s){let r=await s(e,t);r&&(n=r.unsubscribe);return}try{let s=await (0,a.H)();if(i)return;let l=(0,o.$)(s,e,t);l?.unsubscribe&&(r()?n=l.unsubscribe:l.unsubscribe())}catch(e){console.error(e)}}}(),()=>{i=!0,n()}},[e,t,r,s])}}}]);
//# sourceMappingURL=packages_use-alive_use-alive_ts-4493849f2cc0.js.map